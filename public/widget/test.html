<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priyo Widget Test - Backend Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.2s;
        }
        
        .button:hover {
            background: #5a67d8;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
        }
        
        .status.info {
            background: rgba(23, 162, 184, 0.2);
            border: 1px solid #17a2b8;
        }
        
        .code {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        input, textarea {
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin: 5px;
            font-size: 14px;
            width: 200px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Priyo Widget - Backend Integration Test</h1>
        
        <div class="grid">
            <div class="section">
                <h2>üìä Connection Status</h2>
                <div id="backendStatus" class="status info">Checking backend...</div>
                <div id="socketStatus" class="status info">Checking WebSocket...</div>
                <div id="widgetStatus" class="status info">Loading widget...</div>
            </div>

            <div class="section">
                <h2>üéõÔ∏è Widget Controls</h2>
                <button class="button" onclick="openWidget()">Open Widget</button>
                <button class="button" onclick="closeWidget()">Close Widget</button>
                <button class="button" onclick="sendTestMessage()">Send Test Message</button>
                <button class="button" onclick="clearStorage()">Clear Storage</button>
            </div>
        </div>

        <div class="section">
            <h2>üë§ User Configuration</h2>
            <input type="email" id="userEmail" placeholder="Enter email" value="test@example.com">
            <input type="text" id="userName" placeholder="Enter name" value="Test User">
            <button class="button" onclick="setUserInfo()">Set User Info</button>
            <div class="code" id="userInfo">User info will appear here...</div>
        </div>

        <div class="section">
            <h2>üîß Backend API Tests</h2>
            <button class="button" onclick="testHealthEndpoint()">Test Health</button>
            <button class="button" onclick="testConversationAPI()">Test Conversations</button>
            <button class="button" onclick="testMessagesAPI()">Test Messages</button>
            <button class="button" onclick="runAllTests()">Run All Tests</button>
            <div id="apiTestResults"></div>
        </div>

        <div class="section">
            <h2>üìù Event Log</h2>
            <div id="eventLog" class="code" style="height: 200px; overflow-y: auto;"></div>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="section">
            <h2>üí¨ Message Simulation</h2>
            <textarea id="customMessage" placeholder="Enter custom message..." rows="3"></textarea>
            <br>
            <button class="button" onclick="simulateAgentMessage()">Simulate Agent Message</button>
            <button class="button" onclick="simulateTyping()">Simulate Typing</button>
        </div>
    </div>

    <script>
        // Configuration
        window.PRIYO_WIDGET_CONFIG = {
            apiBaseUrl: 'https://priyo-chat-64wg.onrender.com/api',
            socketUrl: 'https://priyo-chat-64wg.onrender.com',
            widgetId: 'test-widget-' + Date.now()
        };

        // Event logging
        function logEvent(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            const logElement = document.getElementById('eventLog');
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }

        // Widget control functions
        function openWidget() {
            if (window.PriyoWidget) {
                window.PriyoWidget.open();
                logEvent('Widget opened programmatically', 'success');
            } else {
                logEvent('Widget not loaded yet', 'error');
            }
        }

        function closeWidget() {
            if (window.PriyoWidget) {
                window.PriyoWidget.close();
                logEvent('Widget closed programmatically', 'success');
            } else {
                logEvent('Widget not loaded yet', 'error');
            }
        }

        function sendTestMessage() {
            if (window.PriyoWidget) {
                window.PriyoWidget.sendCustomMessage('This is a test message from the test page');
                logEvent('Test message sent', 'success');
            } else {
                logEvent('Widget not loaded yet', 'error');
            }
        }

        function setUserInfo() {
            const email = document.getElementById('userEmail').value;
            const name = document.getElementById('userName').value;
            
            if (window.PriyoWidget && email && name) {
                window.PriyoWidget.setUserInfo(email, name);
                document.getElementById('userInfo').textContent = `Email: ${email}, Name: ${name}`;
                logEvent(`User info set: ${name} (${email})`, 'success');
            } else {
                logEvent('Widget not loaded or missing info', 'error');
            }
        }

        function clearStorage() {
            localStorage.removeItem('priyo_user_id');
            localStorage.removeItem('priyo_user_email');
            localStorage.removeItem('priyo_user_name');
            logEvent('Local storage cleared', 'info');
        }

        function clearLog() {
            document.getElementById('eventLog').innerHTML = '';
        }

        // API Testing functions
        async function testHealthEndpoint() {
            try {
                const response = await fetch(`${window.PRIYO_WIDGET_CONFIG.apiBaseUrl}/health`);
                const data = await response.json();
                updateStatus('backendStatus', response.ok ? 'success' : 'error', 
                    response.ok ? '‚úÖ Backend API healthy' : '‚ùå Backend API error');
                logEvent(`Health check: ${response.status} - ${JSON.stringify(data)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                updateStatus('backendStatus', 'error', '‚ùå Backend connection failed');
                logEvent(`Health check failed: ${error.message}`, 'error');
            }
        }

        async function testConversationAPI() {
            try {
                const response = await fetch(`${window.PRIYO_WIDGET_CONFIG.apiBaseUrl}/conversations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'test-user-' + Date.now(),
                        widgetId: window.PRIYO_WIDGET_CONFIG.widgetId,
                        userAgent: navigator.userAgent,
                        url: window.location.href
                    })
                });
                const data = await response.json();
                logEvent(`Conversation API: ${response.status} - ${JSON.stringify(data)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                logEvent(`Conversation API failed: ${error.message}`, 'error');
            }
        }

        async function testMessagesAPI() {
            try {
                const response = await fetch(`${window.PRIYO_WIDGET_CONFIG.apiBaseUrl}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversationId: 'test-conversation',
                        userId: 'test-user',
                        text: 'Test message from API test',
                        type: 'user'
                    })
                });
                const data = await response.json();
                logEvent(`Messages API: ${response.status} - ${JSON.stringify(data)}`, response.ok ? 'success' : 'error');
            } catch (error) {
                logEvent(`Messages API failed: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            logEvent('Running all API tests...', 'info');
            await testHealthEndpoint();
            await testConversationAPI();
            await testMessagesAPI();
            logEvent('All tests completed', 'info');
        }

        function simulateAgentMessage() {
            const message = document.getElementById('customMessage').value || 'This is a simulated agent message';
            if (window.PriyoWidget && window.PriyoWidget.socket) {
                // Simulate incoming message
                window.PriyoWidget.handleIncomingMessage({
                    text: message,
                    sender: 'agent',
                    timestamp: new Date().toISOString(),
                    conversationId: window.PriyoWidget.conversationId
                });
                logEvent('Simulated agent message sent', 'success');
            } else {
                logEvent('Widget or socket not available', 'error');
            }
        }

        function simulateTyping() {
            if (window.PriyoWidget) {
                window.PriyoWidget.showTypingIndicator(true);
                setTimeout(() => {
                    window.PriyoWidget.showTypingIndicator(false);
                }, 3000);
                logEvent('Simulated typing indicator', 'success');
            } else {
                logEvent('Widget not available', 'error');
            }
        }

        function updateStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // Check WebSocket connection
        function checkWebSocket() {
            try {
                const socket = io(window.PRIYO_WIDGET_CONFIG.socketUrl, {
                    transports: ['websocket', 'polling'],
                    timeout: 5000
                });

                socket.on('connect', () => {
                    updateStatus('socketStatus', 'success', '‚úÖ WebSocket connected');
                    logEvent('WebSocket connection successful', 'success');
                    socket.disconnect();
                });

                socket.on('connect_error', (error) => {
                    updateStatus('socketStatus', 'error', '‚ùå WebSocket connection failed');
                    logEvent(`WebSocket error: ${error.message}`, 'error');
                });

                setTimeout(() => {
                    if (!socket.connected) {
                        updateStatus('socketStatus', 'error', '‚ùå WebSocket timeout');
                        logEvent('WebSocket connection timeout', 'error');
                    }
                }, 5000);
            } catch (error) {
                updateStatus('socketStatus', 'error', '‚ùå WebSocket not available');
                logEvent(`WebSocket check failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            logEvent('Test page loaded', 'info');
            
            // Test backend connection
            testHealthEndpoint();
            
            // Check if Socket.IO is available
            if (typeof io !== 'undefined') {
                checkWebSocket();
            } else {
                updateStatus('socketStatus', 'error', '‚ùå Socket.IO not loaded');
            }
            
            // Check widget status
            setTimeout(() => {
                if (window.PriyoWidget) {
                    updateStatus('widgetStatus', 'success', '‚úÖ Widget loaded successfully');
                    logEvent('Widget initialization confirmed', 'success');
                } else {
                    updateStatus('widgetStatus', 'error', '‚ùå Widget failed to load');
                    logEvent('Widget failed to load within 3 seconds', 'error');
                }
            }, 3000);

            // Display current configuration
            logEvent(`Config: ${JSON.stringify(window.PRIYO_WIDGET_CONFIG)}`, 'info');
        });
    </script>
    
    <!-- Load Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Load the widget -->
    <script src="embed-integrated.js" async defer></script>
</body>
</html>
